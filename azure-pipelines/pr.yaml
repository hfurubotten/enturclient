trigger: none

pool:
  vmImage: "ubuntu-latest"

jobs:
  - job: lint_and_format
    displayName: Lint and Format
    workspace:
      clean: all
    steps:
      - template: templates/init-step.yaml
      - bash: |
          source $HOME/.poetry/env
          poetry run black . --check --diff
        displayName: Black check
      - bash: |
          source $HOME/.poetry/env
          poetry run isort --check-only
        displayName: Import sorting
      - bash: |
          source $HOME/.poetry/env
          poetry run pylint enturclient
        displayName: Linting
      - bash: |
          source $HOME/.poetry/env
          poetry run mypy enturclient --ignore-missing-imports --follow-imports=silent --warn-redundant-casts --warn-unused-configs --strict-equality
        displayName: Typing checks
  - job: tests
    displayName: Tests
    workspace:
      clean: all
    steps:
      - template: templates/init-step.yaml
      - bash: |
          source $HOME/.poetry/env
          poetry run pytest --cov=enturclient --cov-report=xml --cov-report=html --junitxml=junit/test-results.xml
        displayName: Tests
      - task: PublishTestResults@2
        condition: succeededOrFailed()
        displayName: Publish test results
        inputs:
          testResultsFiles: "**/test-*.xml"
          testRunTitle: Test results
      - task: PublishCodeCoverageResults@1
        displayName: Publish coverage results
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/coverage.xml"
